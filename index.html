<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>যৌথ খরচের হিসাব (চূড়ান্ত)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Hind Siliguri', sans-serif; background-color: #f7fafc; }
        .modal-backdrop { background-color: rgba(0,0,0,0.5); transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        .data-input:focus, .data-select:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 2px #c7d2fe; }
        .btn-primary { background-color: #4f46e5; color: white; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-primary:disabled { background-color: #a5b4fc; cursor: not-allowed; }
        .btn-danger { background-color: #dc2626; color: white; }
        .btn-danger:hover { background-color: #b91c1c; }
        .btn-secondary { background-color: #6b7280; color: white; }
        .btn-secondary:hover { background-color: #4b5563; }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #4f46e5; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-gray-800">

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-white">
        <div class="loader"></div>
        <p class="mt-4 text-gray-600">কনফিগারেশন লোড হচ্ছে...</p>
    </div>

    <div id="appContent" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 opacity-0 transition-opacity duration-500">
        <header class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">যৌথ খরচের হিসাব</h1>
            <p class="text-gray-500 mt-2">একটি সুরক্ষিত ও রিয়েল-টাইম হিসাব খাতা</p>
        </header>

        <!-- Summary Section -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-6 rounded-xl shadow-md text-center">
                <h2 class="text-lg font-semibold text-gray-800">হারেস কর্তৃক মোট খরচ</h2>
                <p id="haresTotal" class="text-4xl font-bold text-indigo-600 mt-2">৳০</p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-md text-center">
                <h2 class="text-lg font-semibold text-gray-800">শামসু কর্তৃক মোট খরচ</h2>
                <p id="shamsuTotal" class="text-4xl font-bold text-emerald-600 mt-2">৳০</p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-md text-center">
                <h2 class="text-lg font-semibold text-gray-800">সর্বমোট খরচ</h2>
                <p id="grandTotal" class="text-4xl font-bold text-red-600 mt-2">৳০</p>
            </div>
        </div>

        <!-- Add Expense Form -->
        <div class="bg-white p-6 rounded-xl shadow-md mb-8">
            <h3 class="text-xl font-bold mb-4">নতুন খরচ যোগ করুন</h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                <div>
                    <label for="personSelect" class="block text-sm font-medium text-gray-700">কার খরচ?</label>
                    <select id="personSelect" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm data-select">
                        <option value="Hares">হারেস</option>
                        <option value="Shamsu">শামসু</option>
                    </select>
                </div>
                <div>
                    <label for="amountInput" class="block text-sm font-medium text-gray-700">টাকার পরিমাণ</label>
                    <input type="number" id="amountInput" placeholder="টাকার পরিমাণ" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm data-input">
                </div>
                <div class="md:col-span-2">
                    <label for="descInput" class="block text-sm font-medium text-gray-700">খরচের বিবরণ</label>
                    <input type="text" id="descInput" placeholder="বিবরণ লিখুন" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm data-input">
                </div>
            </div>
            <div class="mt-4 flex justify-end">
                <button id="addExpenseBtn" class="py-2 px-6 rounded-lg font-semibold shadow-md transition-transform transform hover:scale-105 btn-primary">খরচ যোগ করুন</button>
            </div>
        </div>

        <!-- Expense Table -->
        <div class="bg-white rounded-xl shadow-md overflow-hidden">
             <div class="overflow-x-auto">
                <table class="w-full" id="expenseTable">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="p-4 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider">খরচকারী</th>
                            <th class="p-4 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider">বিবরণ</th>
                            <th class="p-4 text-right text-sm font-semibold text-gray-600 uppercase tracking-wider">টাকার পরিমাণ</th>
                            <th class="p-4 text-center text-sm font-semibold text-gray-600 uppercase tracking-wider">পদক্ষেপ</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="divide-y divide-gray-200"></tbody>
                </table>
            </div>
             <div class="p-4 bg-gray-50 border-t flex items-center justify-end">
                <button id="exportBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                    এক্সেল (.csv) ফাইলে এক্সপোর্ট
                </button>
            </div>
        </div>
    </div>

    <!-- Password Modal -->
    <div id="passwordModal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm modal-content transform scale-95">
            <h3 class="text-lg font-bold mb-4">পাসওয়ার্ড দিন</h3>
            <p id="modalActionText" class="text-sm text-gray-600 mb-4"></p>
            <input type="password" id="passwordInput" class="w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm data-input" placeholder="এখানে পাসওয়ার্ড লিখুন">
            <p id="passwordError" class="text-red-500 text-xs mt-1 hidden">ভুল পাসওয়ার্ড।</p>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="passwordCancelBtn" class="py-2 px-4 rounded-md font-semibold btn-secondary">বাতিল</button>
                <button id="passwordConfirmBtn" class="py-2 px-4 rounded-md font-semibold btn-primary">নিশ্চিত করুন</button>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md modal-content transform scale-95">
            <h3 class="text-xl font-bold mb-4">খরচ সম্পাদনা করুন</h3>
            <div class="space-y-4">
                <div>
                    <label for="editAmountInput" class="block text-sm font-medium text-gray-700">নতুন টাকার পরিমাণ</label>
                    <input type="number" id="editAmountInput" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm data-input">
                </div>
                <div>
                    <label for="editDescInput" class="block text-sm font-medium text-gray-700">নতুন বিবরণ</label>
                    <input type="text" id="editDescInput" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm data-input">
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="editCancelBtn" class="py-2 px-4 rounded-md font-semibold btn-secondary">বাতিল</button>
                <button id="editConfirmBtn" class="py-2 px-4 rounded-md font-semibold btn-primary">পরিবর্তন সংরক্ষণ করুন</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, serverTimestamp, query, orderBy, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        
        // --- START: Firebase Configuration (USER PROVIDED) ---
        const firebaseConfig = {
            apiKey: "AIzaSyAWUBzk4lHHEByHFSZBmTZbJ10NnhH7i6g",
            authDomain: "joutho-khoroch-khata.firebaseapp.com",
            projectId: "joutho-khoroch-khata",
            storageBucket: "joutho-khoroch-khata.appspot.com",
            messagingSenderId: "856029576027",
            appId: "1:856029576027:web:5bd703a76fcaa5e8b5787e"
        };
        // --- END: Firebase Configuration ---

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        await signInAnonymously(auth).catch(console.error);

        const expensesCollection = collection(db, "expenses");
        
        let passwordsConfig = null;
        let expenses = [];
        let currentAction = null;

        const loadingOverlay = document.getElementById('loadingOverlay');
        const appContent = document.getElementById('appContent');

        async function initializeAppConfig() {
            try {
                const docSnap = await getDoc(doc(db, "config", "passwords"));
                if (docSnap.exists()) {
                    passwordsConfig = docSnap.data();
                    loadingOverlay.style.display = 'none';
                    appContent.style.opacity = 1;
                } else {
                    loadingOverlay.innerHTML = '<p class="text-red-500 font-bold">ত্রুটি: পাসওয়ার্ড কনফিগারেশন খুঁজে পাওয়া যায়নি!</p>';
                }
            } catch(error) {
                console.error("Error fetching password config:", error);
                loadingOverlay.innerHTML = '<p class="text-red-500 font-bold">ডেটাবেস সংযোগে সমস্যা হয়েছে।</p>';
            }
        }
        
        // --- Generic Modal Logic (FIXED) ---
        const openAnimatedModal = (modalElement) => {
            modalElement.classList.remove('hidden');
            setTimeout(() => {
                modalElement.style.opacity = 1; // The modal element itself is the backdrop
                modalElement.querySelector('.modal-content').style.transform = 'scale(1)';
            }, 10);
        };
        const closeAnimatedModal = (modalElement) => {
            modalElement.style.opacity = 0; // The modal element itself is the backdrop
            modalElement.querySelector('.modal-content').style.transform = 'scale(0.95)';
            setTimeout(() => modalElement.classList.add('hidden'), 300);
        };

        // --- Password Modal ---
        const passwordModal = document.getElementById('passwordModal');
        const passwordInput = document.getElementById('passwordInput');
        const passwordError = document.getElementById('passwordError');
        const passwordConfirmBtn = document.getElementById('passwordConfirmBtn');
        const passwordCancelBtn = document.getElementById('passwordCancelBtn');
        const modalActionText = document.getElementById('modalActionText');

        const openPasswordModal = (actionCallback, person, actionText) => {
            modalActionText.textContent = actionText;
            openAnimatedModal(passwordModal);
            passwordInput.value = '';
            passwordError.classList.add('hidden');
            passwordInput.focus();
            currentAction = { callback: actionCallback, person: person };
        };
        passwordConfirmBtn.onclick = () => {
            if (!currentAction || !passwordsConfig) return;
            const password = passwordInput.value;
            const expectedPassword = currentAction.person === 'Hares' ? passwordsConfig.hares_pass : passwordsConfig.shamsu_pass;
            if (password === expectedPassword) {
                currentAction.callback();
                closeAnimatedModal(passwordModal);
            } else {
                passwordError.classList.remove('hidden');
            }
        };
        passwordCancelBtn.onclick = () => closeAnimatedModal(passwordModal);

        // --- Edit Modal ---
        const editModal = document.getElementById('editModal');
        const editAmountInput = document.getElementById('editAmountInput');
        const editDescInput = document.getElementById('editDescInput');
        const editConfirmBtn = document.getElementById('editConfirmBtn');
        const editCancelBtn = document.getElementById('editCancelBtn');
        let currentEditId = null;

        const openEditModal = (expense) => {
            currentEditId = expense.id;
            editAmountInput.value = expense.amount;
            editDescInput.value = expense.description;
            openAnimatedModal(editModal);
        };
        editConfirmBtn.onclick = () => {
            const newAmount = editAmountInput.value;
            const newDesc = editDescInput.value;
            if(!newAmount || !newDesc) {
                alert("দয়া করে উভয় ঘর পূরণ করুন।");
                return;
            }
            const expense = expenses.find(e => e.id === currentEditId);
            const action = () => updateExpense(currentEditId, newAmount, newDesc);
            openPasswordModal(action, expense.person, `পরিবর্তন সংরক্ষণ করার জন্য পাসওয়ার্ড দিন।`);
            closeAnimatedModal(editModal);
        };
        editCancelBtn.onclick = () => closeAnimatedModal(editModal);


        // --- Render and Calculation Logic ---
        const tableBody = document.getElementById('tableBody');
        const formatCurrency = (amount) => `৳${amount.toLocaleString('bn-BD', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

        const renderTable = () => {
            tableBody.innerHTML = '';
            let haresTotal = 0, shamsuTotal = 0;
            expenses.forEach(expense => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                const personColor = expense.person === 'Hares' ? 'text-indigo-600' : 'text-emerald-600';
                row.innerHTML = `
                    <td class="p-4"><span class="font-bold ${personColor}">${expense.person === 'Hares' ? 'হারেস' : 'শামসু'}</span></td>
                    <td class="p-4 text-gray-700">${expense.description}</td>
                    <td class="p-4 text-right font-mono text-gray-800">${formatCurrency(expense.amount)}</td>
                    <td class="p-4 text-center">
                        <button class="edit-btn text-blue-500 hover:text-blue-700 p-1" data-id="${expense.id}">সম্পাদনা</button>
                        <button class="delete-btn text-red-500 hover:text-red-700 p-1" data-id="${expense.id}" data-person="${expense.person}">মুছুন</button>
                    </td>
                `;
                tableBody.appendChild(row);
                if (expense.person === 'Hares') haresTotal += expense.amount;
                else shamsuTotal += expense.amount;
            });
            document.getElementById('haresTotal').textContent = formatCurrency(haresTotal);
            document.getElementById('shamsuTotal').textContent = formatCurrency(shamsuTotal);
            document.getElementById('grandTotal').textContent = formatCurrency(haresTotal + shamsuTotal);
            addTableEventListeners();
        };
        
        // --- Firestore CRUD ---
        const addExpense = async (person, amount, description) => {
            await addDoc(expensesCollection, { person, amount: Number(amount), description, createdAt: serverTimestamp() });
            document.getElementById('amountInput').value = '';
            document.getElementById('descInput').value = '';
        };
        const deleteExpense = async (id) => await deleteDoc(doc(db, "expenses", id));
        const updateExpense = async (id, amount, description) => {
            await updateDoc(doc(db, "expenses", id), { amount: Number(amount), description });
        };

        // --- Event Listeners ---
        function addTableEventListeners() {
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.onclick = (e) => {
                    const { id, person } = e.target.dataset;
                    openPasswordModal(() => deleteExpense(id), person, `এই খরচটি মুছে ফেলার জন্য পাসওয়ার্ড দিন।`);
                };
            });
            document.querySelectorAll('.edit-btn').forEach(button => {
                 button.onclick = (e) => {
                    const expense = expenses.find(ex => ex.id === e.target.dataset.id);
                    if(expense) openEditModal(expense);
                 }
            });
        };
        
        document.getElementById('addExpenseBtn').onclick = () => {
            const person = document.getElementById('personSelect').value;
            const amount = document.getElementById('amountInput').value;
            const description = document.getElementById('descInput').value;
            if (!amount || !description) {
                alert("দয়া করে টাকার পরিমাণ এবং বিবরণ উভয়ই পূরণ করুন।");
                return;
            }
            openPasswordModal(() => addExpense(person, amount, description), person, `নতুন খরচ যোগ করার জন্য পাসওয়ার্ড দিন।`);
        };
        
        document.getElementById('exportBtn').onclick = () => {
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
            csvContent += ["খরচকারী", "বিবরণ", "টাকার পরিমাণ (৳)"].join(",") + "\r\n";
            expenses.forEach(ex => {
                csvContent += [`"${ex.person === 'Hares' ? 'হারেস' : 'শামসু'}"`, `"${ex.description.replace(/"/g, '""')}"`, ex.amount].join(",") + "\r\n";
            });
            const link = document.createElement("a");
            link.href = encodeURI(csvContent);
            link.download = "joutho_khoroch.csv";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // --- Real-time listener & Initial Load ---
        onSnapshot(query(expensesCollection, orderBy("createdAt", "desc")), (snapshot) => {
            expenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderTable();
        });

        initializeAppConfig();
    </script>
</body>
</html>

